# MCPX Dashboard 架构改进方案

## 问题诊断

### 核心问题
1. **双重真相源**：ConfigManager 和 ServerManager 状态不同步
2. **缺乏通知机制**：前端轮询延迟高，无法实时感知变化
3. **全量重载**：单服务器修改导致所有服务器抖动
4. **健康检查不同步**：删除的服务器仍在健康检查列表中

### 影响用户体验的问题
- 对话框延迟显示 → 已修复（使用 isClosing 状态）
- 工具/资源计数为 0 → 已修复（list_servers 添加计数）
- 删除服务器无效 → 已修复（update_config 支持删除）
- 健康检查不同步 → 待修复

---

## 改进方案

### Phase 1: 核心修复（立即实施）

#### 1.1 健康检查器同步
**问题**：删除服务器后，健康检查器仍在检查不存在的服务器

**修改**：
- `ServerManager.disconnect_server()` 必须从健康检查器移除
- `ServerManager.connect_server()` 必须添加到健康检查器
- `reload()` 时智能同步服务器列表

#### 1.2 智能重载替代全量重载
**问题**：`reload()` 关闭所有连接再重建，导致服务中断

**修改**：
- 新增 `reload_server(name)` 单服务器重载
- 改进 `reload()` 只处理变化的服务器
- 保留未变化服务器的连接

#### 1.3 前端即时刷新
**问题**：操作后需要等待轮询才能看到结果

**修改**：
- 操作成功后立即调用 `loadServers()` / `loadConfig()`
- 减少轮询间隔到 10 秒（作为备份）
- 删除操作后等待后端完成再刷新

### Phase 2: 实时推送（短期实施）

#### 2.1 Server-Sent Events
- 后端新增 `/api/events` SSE 端点
- 前端使用 EventSource 监听
- 事件类型：`server_added`, `server_removed`, `server_toggled`, `health_update`

### Phase 3: 架构优化（中期实施）

#### 3.1 统一状态管理
- ServerManager 只接受 ConfigManager
- 移除 ServerManager._config 直接引用
- 所有配置访问通过 ConfigManager

#### 3.2 操作锁机制
- 防止对同一服务器的并发操作
- 确保配置保存和连接操作的原子性

---

## 实施优先级

| 优先级 | 任务 | 预期效果 |
|--------|------|----------|
| P0 | 健康检查同步 | 删除服务器后不再有残留检查 |
| P0 | 智能重载 | 单服务器修改不影响其他服务器 |
| P0 | 前端即时刷新 | 操作后立即看到结果 |
| P1 | SSE 推送 | 实时状态更新，消除轮询 |
| P2 | 统一状态管理 | 消除双重真相源问题 |
